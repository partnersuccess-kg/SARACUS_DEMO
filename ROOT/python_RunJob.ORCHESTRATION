{"job":{"components":{"67674":{"id":67674,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-176,"y":128,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[67678,67679],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Start","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"67675":{"id":67675,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":-48,"y":-64,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python Script 0"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import requests\nimport time\nimport json\n\n\n\nr = requests.post('http://52.212.128.8/rest/v1/group/name/PGroup/project/name/TechWorkshop/version/name/default/job/name/v2_orchestration/run?environmentName=DEMO_SF',\n                  auth=('karey_api','Matillion1'))\n\nrun_job_statuscode = r.status_code\nprint('Run Job Status Code: '+str(run_job_statuscode))\n\nrun_job_id = json.loads(r.text)['id']\nprint('Run Job ID: '+str(run_job_id))\n\n\nif run_job_statuscode==200:\n  print('Job currently running...')\n  \ntime.sleep(5)\n\n\n\nr2 = requests.get('http://52.212.128.8/rest/v1/group/name/PGroup/project/name/TechWorkshop/task/history?since=2022-08-15',\n                    auth=('karey_api','Matillion1'))\nresponse_json = json.loads(r2.text)\njob_ids = []\nfor each in response_json:\n  job_ids.append(each['id'])\n#print(job_ids)  \n\njob_history_response = []\n\nwhile run_job_id not in job_ids:\n  time.sleep(15)\n  r2 = requests.get('http://52.212.128.8/rest/v1/group/name/PGroup/project/name/TechWorkshop/task/history?since=2022-08-15',\n                    auth=('karey_api','Matillion1'))\n  response_json = json.loads(r2.text)\n  for each in response_json:\n    job_ids.append(each['id'])\n    if each['id'] == run_job_id:\n      job_history_response.append(response_json)\n  #print(job_ids)\n\nmatch_response = []\n\n#print(job_history_response)\nfor each in job_history_response:\n  for each_each in each:\n    if each_each['id'] == run_job_id:\n      match_response.append(each_each)\n      \nfor each in match_response:\n  print(each['state'])\n  for key, value in each.items():\n    print(key,' : ',value)"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"67676":{"id":67676,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":-48,"y":128,"width":32,"height":32,"inputConnectorIDs":[67678],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Tasks History"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"# BACKGROUND:\n# This Python script has the purpose of initiating a job on a remote Matillion instance using the Running Jobs API endpoint, then will monitor the running of the job using the Tasks API endpoint.\n\n# PREREQUISITES:\n# Set the following job variables in the job: environment, instance_url, job_name, password, project_group, project name, version\n\n\n# Import modules & set variables\nimport requests\nimport time\nimport json\nfrom datetime import date\n\ntoday = date.today()\ncurrent_date = today.strftime(\"%Y-%m-%d\")\ntasks_history_get = instance_url+'/rest/v1/group/name/'+project_group+'/project/name/'+project_name+'/task/history?since='+current_date\n  \n# \tGET task history to evaluate success or failure of triggered job\nr2 = requests.get(tasks_history_get,auth=(username,password))\n\nresponse_json = json.loads(r2.text)\n\nprint(response_json)\n\njob_ids = []\n\nfor each in response_json:\n  job_ids.append(each['id'])\n\n  "}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"67677":{"id":67677,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":-48,"y":16,"width":32,"height":32,"inputConnectorIDs":[67679],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Matillion RunAJob Script"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"# BACKGROUND:\n# This Python script has the purpose of initiating a job on a remote Matillion instance using the Running Jobs API endpoint, then will monitor the running of the job using the Tasks API endpoint.\n\n# PREREQUISITES:\n# Set the following job variables in the job: environment, instance_url, job_name, password, project_group, project name, version\n\n\n# Import modules & set variables\nimport requests\nimport time\nimport json\nfrom datetime import date\n\ntoday = date.today()\ncurrent_date = today.strftime(\"%Y-%m-%d\")\njob_run_post = instance_url+'/rest/v1/group/name/'+project_group+'/project/name/'+project_name+'/version/name/'+version+'/job/name/'+job_name+'/run?environmentName='+environment\ntasks_history_get = instance_url+'/rest/v1/group/name/'+project_group+'/project/name/'+project_name+'/task/history?since='+current_date\n\n\n# Perform POST to initiate the target job\nr = requests.post(job_run_post,auth=(username,password))\n\nrun_job_statuscode = r.status_code\nprint('\\n Run Job Status Code: '+str(run_job_statuscode)) #Print status code of API call\n\nrun_job_id = json.loads(r.text)['id'] #Prints the Job ID which wil be referenced for the remainder of script\nprint('Run Job ID: '+str(run_job_id))\n\nif run_job_statuscode==200:\n  print('Job currently running...') \n  \n  \n# \tGET task history to evaluate success or failure of triggered job\ntime.sleep(5)\n\nr2 = requests.get(tasks_history_get,auth=(username,password))\n\nresponse_json = json.loads(r2.text)\n\njob_ids = []\n\nfor each in response_json:\n  job_ids.append(each['id'])\n\n  \n#Performs interval of 15 seconds between API calls, awaiting conclusion of triggered job\njob_history_response = []\n\nwhile run_job_id not in job_ids:\n  time.sleep(15)\n  r2 = requests.get(tasks_history_get,auth=(username,password))\n  response_json = json.loads(r2.text)\n  for each in response_json:\n    job_ids.append(each['id'])\n    if each['id'] == run_job_id:\n      job_history_response.append(response_json)\n\n#Extract JSON body related to job run, communicate success or failure, reports job statistics\nmatch_response = []\n\nfor each in job_history_response:\n  for each_each in each:\n    if each_each['id'] == run_job_id:\n      match_response.append(each_each)\n      \nfor each in match_response:\n  print(each['state'])\n  for key, value in each.items():\n    print(key,' : ',value)"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{},"unconditionalConnectors":{"67678":{"id":67678,"sourceID":67674,"targetID":67676},"67679":{"id":67679,"sourceID":67674,"targetID":67677}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{"environment":{"definition":{"name":"environment","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"DEMO_SF"},"instance_url":{"definition":{"name":"instance_url","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"http://52.212.128.8"},"job_name":{"definition":{"name":"job_name","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"v2_orchestration"},"password":{"definition":{"name":"password","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"Matillion1"},"project_group":{"definition":{"name":"project_group","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"PGroup"},"project_name":{"definition":{"name":"project_name","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"TechWorkshop"},"s3_directory":{"definition":{"name":"s3_directory","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"CFB/SNFK/"},"s3_file":{"definition":{"name":"s3_file","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"PlayerStats_2018.csv"},"username":{"definition":{"name":"username","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"karey_api"},"version":{"definition":{"name":"version","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"default"}},"grids":{}},"info":{"name":"python_RunJob","description":"","type":"ORCHESTRATION","tag":"02bf52a8-4afa-4065-bae9-d21d044b192e"}}